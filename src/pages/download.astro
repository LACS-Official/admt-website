---
import MainLayout from "@/layouts/MainLayout.astro";
import { SITE_CONFIG } from "@/config/site";
import ScrollColorAnimation from "@/components/ScrollColorAnimation.astro";
import VersionHistory from "@/components/VersionHistory.astro";
import DownloadsSection from "@/components/DownloadsSection.astro";
import { deviceManagerVersionApi } from "@/services/versionApi";

// Fetch dynamic data at build/request time
const dynamicConfig =
  await deviceManagerVersionApi.generateDynamicDownloadConfig();
const latestVersion = dynamicConfig?.version || "1.3.1";
const downloads = dynamicConfig?.allDownloadLinks || {};
const versions = dynamicConfig?.allVersions || [];
---

<MainLayout
  title="下载 - 玩机管家"
  description="下载玩机管家 (Android Device Management Tool)，支持 Windows、macOS 和 Linux。立即开始管理您的 Android 设备。"
>
  <!-- Latest Version Showcase -->
  <section
    class="latest-version-showcase py-10 md:py-20 bg-white dark:bg-black overflow-hidden relative"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="text-center mb-16">
        <div
          class="inline-flex items-center space-x-2 px-4 py-1.5 rounded-full bg-blue-50/10 dark:bg-blue-900/30 border border-blue-100/20 dark:border-blue-800 text-blue-600 dark:text-blue-400 text-sm font-medium mb-6 animate-fade-in mx-auto backdrop-blur-md"
        >
          <span class="relative flex h-2 w-2">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"
            ></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"
            ></span>
          </span>
          <span>最新稳定版 v{latestVersion} 已发布</span>
        </div>
        <h1
          class="text-4xl md:text-8xl font-bold text-gray-900 dark:text-white mb-6 md:mb-8 tracking-tighter"
        >
          立即体验 <span
            class="bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent italic"
            >ADMT</span
          >
        </h1>
        <p
          class="text-base md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto font-light mb-8 md:mb-12"
        >
          强大、简洁、优雅的安卓设备跨平台全能管理工具
        </p>

        <!-- Dynamic Download Buttons -->
        <div class="flex flex-wrap justify-center gap-4 max-w-3xl mx-auto">
          {
            downloads.quark && (
              <a
                href={downloads.quark}
                target="_blank"
                class="group relative px-8 py-4 bg-[#006CFF] text-white rounded-2xl font-bold text-lg hover:shadow-[0_20px_40px_rgba(0,108,255,0.3)] transition-all flex items-center gap-3"
              >
                <span class="w-6 h-6 bg-white rounded-full flex items-center justify-center text-[#006CFF] text-[10px]">
                  Q
                </span>
                夸克网盘下载
                <div class="absolute -top-3 -right-3 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full animate-bounce">
                  极速
                </div>
              </a>
            )
          }
          {
            downloads.thunderPan && (
              <a
                href={downloads.thunderPan}
                target="_blank"
                class="px-8 py-4 bg-[#1F4CFF] text-white rounded-2xl font-bold text-lg hover:shadow-[0_20px_40px_rgba(31,76,255,0.3)] transition-all flex items-center gap-3"
              >
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2z" />
                </svg>
                迅雷网盘下载
              </a>
            )
          }
          {
            downloads.baidu && (
              <a
                href={downloads.baidu}
                target="_blank"
                class="px-8 py-4 bg-[#212121] dark:bg-white dark:text-black text-white rounded-2xl font-bold text-lg hover:shadow-xl transition-all flex items-center gap-3"
              >
                <span class="text-blue-500 font-extrabold text-xl font-serif">
                  du
                </span>
                百度网盘下载
              </a>
            )
          }
        </div>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 max-w-6xl mx-auto"
      >
        <!-- Windows Platform -->
        <div
          class="platform-card p-8 rounded-3xl bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 backdrop-blur-sm"
        >
          <div class="flex items-center gap-4 mb-8">
            <div
              class="w-12 h-12 rounded-2xl bg-blue-600/10 flex items-center justify-center text-blue-600"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"
                ><path
                  d="M0 3.449L9.75 2.1V11.75H0V3.449zm0 9.151h9.75v9.6L0 20.849V12.6zm10.55 9.8l13.45 1.85V12.6H10.55v9.85zM10.55 1.8V11.75H24V0L10.55 1.8z"
                ></path></svg
              >
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                Windows
              </h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Windows 10/11 (64-bit)
              </p>
            </div>
          </div>
          <div class="space-y-4">
            <div
              class="info-item p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700"
            >
              <div class="font-semibold text-gray-900 dark:text-white">
                Installer (.exe)
              </div>
            </div>
            <div
              class="info-item p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700"
            >
              <div class="font-semibold text-gray-900 dark:text-white">
                MSI Package
              </div>
            </div>
          </div>
        </div>

        <!-- Linux Platform -->
        <div
          class="platform-card p-8 rounded-3xl bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 backdrop-blur-sm"
        >
          <div class="flex items-center gap-4 mb-8">
            <div
              class="w-12 h-12 rounded-2xl bg-orange-600/10 flex items-center justify-center text-orange-600"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"
                ><path
                  d="M12.001 2c-1.103 0-2 .897-2 2s.897 2 2 2 2-.897 2-2-.897-2-2-2zM4.001 10h16v2h-16v-2zm-1 3h18v7c0 1.103-.897 2-2 2h-14c-1.103 0-2-.897-2-2v-7zm3 2v4h4v-4h-4zm8 0v4h4v-4h-4z"
                ></path></svg
              >
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                Linux
              </h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Ubuntu, Fedora, Arch, etc.
              </p>
            </div>
          </div>
          <div class="space-y-4">
            <div
              class="info-item p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700"
            >
              <div class="font-semibold text-gray-900 dark:text-white">
                AppImage
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div
                class="info-item p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-center"
              >
                <div class="font-semibold text-gray-900 dark:text-white">
                  DEB
                </div>
              </div>
              <div
                class="info-item p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-center"
              >
                <div class="font-semibold text-gray-900 dark:text-white">
                  RPM
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- macOS Platform (Poll) -->
        <div
          class="platform-card p-8 rounded-3xl bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 backdrop-blur-sm"
        >
          <div class="flex items-center gap-4 mb-8">
            <div
              class="w-12 h-12 rounded-2xl bg-black/10 flex items-center justify-center text-black dark:text-white"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"
                ><path
                  d="M17.05 20.28c-.98.95-2.05 1.61-3.14 1.61-1.09 0-1.63-.64-3-.64-1.37 0-1.91.64-3 .64-1.09 0-2.16-.66-3.14-1.61-2.48-2.39-3.77-6.28-3.77-9.45 0-4.04 2.5-6.17 4.9-6.17 1.25 0 2.22.47 3.01.47.79 0 1.76-.47 3.01-.47 2.4 0 4.9 2.13 4.9 6.17 0 .5-.03 1.05-.08 1.6-.26-.14-.54-.25-.83-.34-1-.34-2.1-.28-3.05.15-.95.43-1.68 1.15-2.11 2.1-.43.95-.49 2.05-.15 3.05.3.88.85 1.62 1.57 2.15l-.08.68c-.14 1.34-.48 2.39-1 3.25zm.95-15.08c0 1.64-.81 3.14-2.13 3.93.38-1.58.12-3.14-.8-4.43 1.58-.38 2.93.5 2.93.5zm-1.12 6.8c.24-.67.75-1.18 1.42-1.42.67-.24 1.44-.19 2.07.13.63.32 1.12.87 1.36 1.54.24.67.19 1.44-.13 2.07-.32.63-.87 1.12-1.54 1.36-.67.24-1.44.19-2.07-.13-.63-.32-1.12-.87-1.36-1.54-.24-.67-.19-1.44.13-2.07.32-.63.87-1.12 1.54-1.36.67-.24 1.44-.19 2.07.13.04-.08.08-.16.11-.25z"
                ></path></svg
              >
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                macOS
              </h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Apple Silicon / Intel
              </p>
            </div>
          </div>
          <div class="space-y-6">
            <button
              id="macos-poll-button"
              class="w-full py-4 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              期待 macOS 版本
            </button>
            <div
              class="text-center pt-2 border-t border-gray-100 dark:border-gray-800"
            >
              <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                已有 <span id="macos-poll-count" class="text-blue-600 font-bold"
                  >...</span
                > 人表示感兴趣
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-16 text-center">
        <p class="text-sm text-gray-500 dark:text-gray-400">
          * 暂无 macOS
          版本发布计划。如需更多下载方式，请查看下方历史版本或第三方源。
        </p>
      </div>
    </div>
  </section>

  <!-- Version History -->
  <VersionHistory versions={versions} />

  <!-- 滚动效果组件 -->
  <ScrollColorAnimation />
</MainLayout>

<script is:inline>
  // macOS Poll Logic
  document.addEventListener("DOMContentLoaded", () => {
    const pollButton = document.getElementById("macos-poll-button");
    const pollCountLabel = document.getElementById("macos-poll-count");
    const STORAGE_KEY = "admt_macos_voted";
    const API_URL = "/api/macos-poll";

    async function updateCount() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error("Fetch failed");
        const data = await response.json();
        pollCountLabel.textContent = data.count;
      } catch (e) {
        pollCountLabel.textContent = "0"; // Fallback display
      }
    }

    async function handleVote() {
      if (localStorage.getItem(STORAGE_KEY)) return;

      try {
        const response = await fetch(API_URL, { method: "POST" });
        if (!response.ok) throw new Error("Post failed");
        const data = await response.json();
        pollCountLabel.textContent = data.count;
        localStorage.setItem(STORAGE_KEY, "true");
        disableButton();
      } catch (e) {
        console.error("Vote failed", e);
      }
    }

    function disableButton() {
      if (!pollButton) return;
      pollButton.disabled = true;
      pollButton.textContent = "已提交意向";
      pollButton.classList.remove("bg-blue-600", "hover:bg-blue-700");
      pollButton.classList.add(
        "bg-gray-200",
        "text-gray-500",
        "dark:bg-gray-800",
      );
    }

    if (pollButton) {
      if (localStorage.getItem(STORAGE_KEY)) {
        disableButton();
      }
      pollButton.addEventListener("click", handleVote);
      updateCount();
    }
  });
</script>

<style>
  /* Hero Section Background */
  .hero-section {
    position: relative;
    background-image: url("/img/admt-bg.webp");
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }

  /* Background overlay for better text readability */
  .hero-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.75);
    z-index: 1;
  }

  /* Dark mode overlay */
  :global(.dark) .hero-section::before {
    background: rgba(0, 0, 0, 0.7);
  }

  /* Ensure content is above the overlay */
  .hero-section > div {
    position: relative;
    z-index: 2;
  }

  /* Responsive background attachment */
  @media (max-width: 768px) {
    .hero-section {
      background-attachment: scroll;
    }
  }

  /* Enhance text contrast on background */
  .hero-section h1,
  .hero-section p {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .hero-section h1,
  :global(.dark) .hero-section p {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
</style>
