---
import DocsLayout from '@/layouts/DocsLayout.astro';
import MarkdownRenderer from '@/components/MarkdownRenderer.astro';
import { readFileSync } from 'fs';
import { join } from 'path';

// 读取markdown文件内容
const markdownPath = join(process.cwd(), 'public/docs/troubleshooting/faq.md');
let markdownContent = '';

try {
  markdownContent = readFileSync(markdownPath, 'utf-8');
  // 移除markdown的前置标题，因为我们在布局中已经有了
  markdownContent = markdownContent.replace(/^# .*\n\n/, '');
} catch (error) {
  console.error('Error reading markdown file:', error);
  markdownContent = '文档内容加载失败，请稍后重试。';
}
---

<DocsLayout 
  title="常见问题解答" 
  description="用户最常遇到的问题和解决方案"
  currentPath="常见问题"
>
  <!-- 搜索框 -->
  <div class="not-prose mb-8">
    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 border border-blue-200 dark:border-blue-700">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        <span class="text-2xl mr-2">🔍</span>
        快速查找问题
      </h2>
      <div class="relative">
        <input
          type="text"
          id="faq-search"
          placeholder="输入关键词搜索问题..."
          class="w-full px-4 py-3 pl-12 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
        />
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      <p class="text-gray-600 dark:text-gray-300 text-sm mt-2">
        输入关键词如"连接"、"安装"、"激活"等来快速找到相关问题
      </p>
    </div>
  </div>

  <!-- 问题分类快速导航 -->
  <div class="not-prose mb-8">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">问题分类</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <a href="#installation" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">🔧</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">安装启动</span>
      </a>
      <a href="#connection" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">📱</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">设备连接</span>
      </a>
      <a href="#features" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">🎮</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">功能使用</span>
      </a>
      <a href="#settings" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">⚙️</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">设置配置</span>
      </a>
      <a href="#license" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">🔐</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">许可激活</span>
      </a>
      <a href="#updates" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 text-center">
        <span class="text-3xl mb-2">🔄</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white">更新升级</span>
      </a>
    </div>
  </div>

  <!-- 热门问题 -->
  <div class="not-prose mb-8">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">🔥 热门问题</h2>
    <div class="space-y-4">
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4">
        <h3 class="font-semibold text-gray-900 dark:text-white mb-2 flex items-center">
          <span class="text-red-500 mr-2">🔥</span>
          设备连接后立即断开
        </h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
          最常见的连接问题，通常是电源管理导致的。
        </p>
        <a href="#device-disconnect" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm font-medium">
          查看解决方案 →
        </a>
      </div>

      <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700 rounded-lg p-4">
        <h3 class="font-semibold text-gray-900 dark:text-white mb-2 flex items-center">
          <span class="text-orange-500 mr-2">🔥</span>
          程序安装后无法启动
        </h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
          通常是缺少运行库或权限问题导致的。
        </p>
        <a href="#startup-failed" class="text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300 text-sm font-medium">
          查看解决方案 →
        </a>
      </div>

      <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
        <h3 class="font-semibold text-gray-900 dark:text-white mb-2 flex items-center">
          <span class="text-yellow-500 mr-2">🔥</span>
          屏幕镜像延迟高或卡顿
        </h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
          性能优化问题，可以通过调整设置改善。
        </p>
        <a href="#performance-lag" class="text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 text-sm font-medium">
          查看解决方案 →
        </a>
      </div>
    </div>
  </div>

  <!-- 主要内容 -->
  <div id="faq-content">
    <MarkdownRenderer content={markdownContent} />
  </div>

  <!-- 没找到答案 -->
  <div class="not-prose mt-12">
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6 border border-blue-200 dark:border-blue-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        <span class="text-2xl mr-2">❓</span>
        没找到您要的答案？
      </h3>
      <p class="text-gray-600 dark:text-gray-300 mb-4">
        如果以上常见问题没有解决您的疑问，我们还有更多获取帮助的方式：
      </p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="/docs/troubleshooting" class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
          <span class="text-2xl mr-3">🔧</span>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white">故障排除</h4>
            <p class="text-gray-600 dark:text-gray-300 text-sm">详细的问题诊断</p>
          </div>
        </a>
        <a href="https://www.lacs.cc/contact" class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
          <span class="text-2xl mr-3">📧</span>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white">联系支持</h4>
            <p class="text-gray-600 dark:text-gray-300 text-sm">专业技术支持</p>
          </div>
        </a>
        <a href="https://github.com/yourcompany/android-device-management-tool/issues" class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
          <span class="text-2xl mr-3">💬</span>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-white">社区讨论</h4>
            <p class="text-gray-600 dark:text-gray-300 text-sm">与其他用户交流</p>
          </div>
        </a>
      </div>
    </div>
  </div>
</DocsLayout>

<script>
  // FAQ搜索功能
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('faq-search');
    const faqContent = document.getElementById('faq-content');
    
    if (searchInput && faqContent) {
      let searchTimeout;
      
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const query = e.target.value.toLowerCase().trim();
          
          if (query === '') {
            // 显示所有内容
            const allElements = faqContent.querySelectorAll('h2, h3, p, li, details');
            allElements.forEach(el => {
              el.style.display = '';
            });
            return;
          }
          
          // 搜索匹配的内容
          const allElements = faqContent.querySelectorAll('h2, h3, p, li, details');
          let hasResults = false;
          
          allElements.forEach(el => {
            const text = el.textContent.toLowerCase();
            if (text.includes(query)) {
              el.style.display = '';
              hasResults = true;
              
              // 如果是details元素，自动展开
              if (el.tagName === 'DETAILS') {
                el.open = true;
              }
            } else {
              el.style.display = 'none';
            }
          });
          
          // 如果没有结果，显示提示
          if (!hasResults) {
            const noResults = document.createElement('div');
            noResults.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
            noResults.innerHTML = `
              <div class="text-4xl mb-4">🔍</div>
              <p class="text-lg font-medium mb-2">没有找到相关问题</p>
              <p class="text-sm">尝试使用其他关键词，或者<a href="https://www.lacs.cc/contact" class="text-blue-600 dark:text-blue-400 hover:underline">联系技术支持</a></p>
            `;
            noResults.id = 'no-results';
            
            // 移除之前的无结果提示
            const existingNoResults = document.getElementById('no-results');
            if (existingNoResults) {
              existingNoResults.remove();
            }
            
            faqContent.appendChild(noResults);
          } else {
            // 移除无结果提示
            const existingNoResults = document.getElementById('no-results');
            if (existingNoResults) {
              existingNoResults.remove();
            }
          }
        }, 300);
      });
    }
    
    // 平滑滚动到锚点
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  });
</script>
