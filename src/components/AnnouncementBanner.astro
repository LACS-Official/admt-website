---
/**
 * å…¬å‘Šæ¨ªå¹…ç»„ä»¶
 * ç”¨äºåœ¨ä¸»é¡µæ˜¾ç¤ºé‡è¦å…¬å‘Šä¿¡æ¯
 */
---

<div id="announcement-banner" class="announcement-banner hidden">
  <!-- å…¬å‘Šå®¹å™¨ -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="announcement-content">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="announcement-loading" class="flex items-center justify-center py-3">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600"></div>
        <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">åŠ è½½å…¬å‘Šä¸­...</span>
      </div>
      
      <!-- å…¬å‘Šåˆ—è¡¨ -->
      <div id="announcement-list" class="hidden space-y-2">
        <!-- å…¬å‘Šé¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
      </div>
      
      <!-- é”™è¯¯çŠ¶æ€ -->
      <div id="announcement-error" class="hidden text-center py-3">
        <span class="text-sm text-gray-500 dark:text-gray-400">æš‚æ— å…¬å‘Šä¿¡æ¯</span>
      </div>
    </div>
  </div>
</div>

<style>
  .announcement-banner {
    @apply bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-b border-blue-200 dark:border-gray-600;
    display: block !important;
  }

  .announcement-banner.hidden {
    display: none !important;
  }

  .announcement-item {
    @apply flex items-start space-x-3 p-3 rounded-lg transition-all duration-200;
  }

  .announcement-item:hover {
    @apply bg-white/50 dark:bg-gray-700/50;
  }

  .announcement-icon {
    @apply flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm;
  }

  .announcement-content-text {
    @apply flex-1 min-w-0;
  }

  .announcement-title {
    @apply font-medium text-gray-900 dark:text-white text-sm leading-5;
  }

  .announcement-meta {
    @apply flex items-center space-x-2 mt-1;
  }

  .announcement-type {
    @apply inline-flex items-center px-2 py-0.5 rounded text-xs font-medium;
  }

  .announcement-date {
    @apply text-xs text-gray-500 dark:text-gray-400;
  }

  .announcement-priority-high {
    @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
  }

  .announcement-priority-normal {
    @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
  }

  .announcement-priority-low {
    @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
  }

  .announcement-type-update {
    @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200;
  }

  .announcement-type-feature {
    @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
  }

  .announcement-type-security {
    @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
  }

  .announcement-type-maintenance {
    @apply bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200;
  }

  .announcement-type-general {
    @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200;
  }

  .announcement-urgent {
    @apply animate-pulse;
  }

  .announcement-close {
    @apply flex-shrink-0 ml-2 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors;
  }
</style>

<script is:inline>
  // å…¬å‘Šæ¨ªå¹…ç®¡ç†å™¨
  class AnnouncementBanner {
    constructor() {
      this.container = document.getElementById('announcement-banner');
      this.loadingElement = document.getElementById('announcement-loading');
      this.listElement = document.getElementById('announcement-list');
      this.errorElement = document.getElementById('announcement-error');
    }

    async init() {
      if (!this.container) {
        console.log('Announcement banner container not found');
        return;
      }

      console.log('Initializing announcement banner...');

      try {
        this.showLoading();
        this.showBanner(); // å…ˆæ˜¾ç¤ºå®¹å™¨

        // ä½¿ç”¨fetchç›´æ¥è°ƒç”¨API
        console.log('Fetching announcements from API...');
        const response = await fetch('https://api-g.lacs.cc/app/software/id/1/announcements?published=true&limit=3');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('API response:', data);

        if (data.success && data.data && data.data.length > 0) {
          console.log(`Found ${data.data.length} announcements`);
          this.renderAnnouncements(data.data);
        } else {
          console.log('No announcements found or API returned empty data, showing placeholder');
          console.log('API response details:', { success: data.success, dataLength: data.data ? data.data.length : 'no data' });
          this.showPlaceholder();
        }
      } catch (error) {
        console.error('Failed to load announcements:', error);
        console.log('Showing placeholder due to error');
        this.showPlaceholder();
      }
    }

    showLoading() {
      if (this.loadingElement) this.loadingElement.classList.remove('hidden');
      if (this.listElement) this.listElement.classList.add('hidden');
      if (this.errorElement) this.errorElement.classList.add('hidden');
    }

    showError() {
      if (this.loadingElement) this.loadingElement.classList.add('hidden');
      if (this.listElement) this.listElement.classList.add('hidden');
      if (this.errorElement) this.errorElement.classList.remove('hidden');
      this.showBanner();
    }

    showBanner() {
      if (this.container) {
        this.container.classList.remove('hidden');
      }
    }

    hideBanner() {
      if (this.container) {
        this.container.classList.add('hidden');
      }
    }

    showPlaceholder() {
      console.log('Showing placeholder announcement...');
      // æ˜¾ç¤ºä¸€ä¸ªç¤ºä¾‹å…¬å‘Šï¼Œå½“APIæ²¡æœ‰æ•°æ®æ—¶
      const placeholderAnnouncements = [
        {
          id: 1,
          title: 'ç©æœºç®¡å®¶æ­£åœ¨æŒç»­æ›´æ–°ä¸­',
          content: 'æˆ‘ä»¬æ­£åœ¨ä¸æ–­æ”¹è¿›äº§å“åŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æ›´å¥½çš„è®¾å¤‡ç®¡ç†ä½“éªŒã€‚æ•¬è¯·æœŸå¾…æ›´å¤šåŠŸèƒ½ï¼',
          type: 'general',
          priority: 'normal',
          publishedAt: new Date().toISOString(),
          metadata: { urgent: false }
        }
      ];

      console.log('Placeholder announcements:', placeholderAnnouncements);
      this.renderAnnouncements(placeholderAnnouncements);
    }

    renderAnnouncements(announcements) {
      if (!this.listElement) return;

      this.listElement.innerHTML = '';

      announcements.forEach((announcement) => {
        const announcementElement = this.createAnnouncementElement(announcement);
        this.listElement.appendChild(announcementElement);
      });

      if (this.loadingElement) this.loadingElement.classList.add('hidden');
      if (this.listElement) this.listElement.classList.remove('hidden');
    }

    createAnnouncementElement(announcement) {
      const div = document.createElement('div');
      div.className = `announcement-item ${announcement.metadata?.urgent ? 'announcement-urgent' : ''}`;

      const iconClass = this.getPriorityIconClass(announcement.priority);
      const typeClass = this.getTypeClass(announcement.type);
      const typeIcon = this.getTypeIcon(announcement.type);
      const typeLabel = this.getTypeLabel(announcement.type);
      const formattedDate = this.formatDate(announcement.publishedAt);

      div.innerHTML = `
        <div class="announcement-icon ${iconClass}">
          ${typeIcon}
        </div>
        <div class="announcement-content-text">
          <div class="announcement-title">
            ${this.escapeHtml(announcement.title)}
          </div>
          <div class="announcement-meta">
            <span class="announcement-type ${typeClass}">
              ${typeLabel}
            </span>
            <span class="announcement-date">
              ${formattedDate}
            </span>
            ${this.isExpiringSoon(announcement.expiresAt) ? '<span class="text-xs text-orange-600 dark:text-orange-400">å³å°†è¿‡æœŸ</span>' : ''}
          </div>
        </div>
        <button class="announcement-close" onclick="this.parentElement.style.display='none'" aria-label="å…³é—­å…¬å‘Š">
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;

      return div;
    }

    getPriorityIconClass(priority) {
      switch (priority) {
        case 'high': return 'announcement-priority-high';
        case 'normal': return 'announcement-priority-normal';
        case 'low': return 'announcement-priority-low';
        default: return 'announcement-priority-normal';
      }
    }

    getTypeClass(type) {
      switch (type) {
        case 'update': return 'announcement-type-update';
        case 'feature': return 'announcement-type-feature';
        case 'security': return 'announcement-type-security';
        case 'maintenance': return 'announcement-type-maintenance';
        default: return 'announcement-type-general';
      }
    }

    getTypeIcon(type) {
      switch (type) {
        case 'update': return 'ğŸ”„';
        case 'feature': return 'âœ¨';
        case 'security': return 'ğŸ”’';
        case 'maintenance': return 'ğŸ”§';
        case 'bugfix': return 'ğŸ›';
        case 'general': return 'ğŸ“¢';
        case 'promotion': return 'ğŸ‰';
        case 'deprecation': return 'âš ï¸';
        default: return 'ğŸ“¢';
      }
    }

    getTypeLabel(type) {
      switch (type) {
        case 'update': return 'æ›´æ–°';
        case 'feature': return 'æ–°åŠŸèƒ½';
        case 'security': return 'å®‰å…¨';
        case 'maintenance': return 'ç»´æŠ¤';
        case 'bugfix': return 'ä¿®å¤';
        case 'general': return 'é€šçŸ¥';
        case 'promotion': return 'æ¨å¹¿';
        case 'deprecation': return 'å¼ƒç”¨';
        default: return 'é€šçŸ¥';
      }
    }

    formatDate(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = now.getTime() - date.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'ä»Šå¤©';
        if (diffDays === 1) return 'æ˜¨å¤©';
        if (diffDays < 7) return `${diffDays}å¤©å‰`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`;

        return date.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return 'æœªçŸ¥æ—¶é—´';
      }
    }

    isExpiringSoon(expiresAt) {
      if (!expiresAt) return false;

      try {
        const expireDate = new Date(expiresAt);
        const now = new Date();
        const diffTime = expireDate.getTime() - now.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        return diffDays <= 7 && diffDays > 0;
      } catch (error) {
        return false;
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // åˆå§‹åŒ–å…¬å‘Šæ¨ªå¹…
  document.addEventListener('DOMContentLoaded', () => {
    const banner = new AnnouncementBanner();
    banner.init();
  });
</script>
