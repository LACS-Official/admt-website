---
/**
 * ç®€åŒ–ç‰ˆå…¬å‘Šæ¨ªå¹…ç»„ä»¶
 * ç”¨äºæµ‹è¯•å’Œç¡®ä¿å…¬å‘ŠåŠŸèƒ½æ­£å¸¸å·¥ä½œ
 */
---

<!-- å…¬å‘Šæ¨ªå¹… - åªåœ¨æœ‰çœŸå®APIæ•°æ®æ—¶æ˜¾ç¤º -->
<div id="announcement-banner" class="announcement-banner fixed top-0 left-0 right-0 z-50 bg-black bg-opacity-80 dark:bg-white dark:bg-opacity-10 shadow-xl backdrop-blur-sm transform -translate-y-full transition-transform duration-500 ease-out" style="display: none;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
    <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
    <div id="countdown-display" class="absolute top-3 right-6 text-white text-xs font-bold bg-black bg-opacity-30 rounded-full w-7 h-7 flex items-center justify-center opacity-70 transition-all duration-300 hover:opacity-90 hover:scale-110" style="display: none; font-family: 'Courier New', monospace;">
      <span id="countdown-number" style="transition: transform 0.15s ease-out;">5</span>
    </div>

    <div id="announcement-content" class="announcement-content">
      <!-- å…¬å‘Šå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
    </div>
  </div>
</div>

<!-- æ— å…¬å‘ŠçŠ¶æ€æç¤º - ä»…ç”¨äºè°ƒè¯•ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸æ˜¾ç¤º -->
<div id="no-announcements-debug" class="hidden fixed top-4 right-4 z-40 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 px-4 py-2 rounded-lg text-sm">
  æš‚æ— å…¬å‘Š
</div>

<script is:inline>
  // å…¬å‘Šæ¨ªå¹…ç®¡ç† - ä»…ä½¿ç”¨çœŸå®APIæ•°æ®
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Loading announcements from API...');

    const banner = document.getElementById('announcement-banner');
    const content = document.getElementById('announcement-content');
    const debugElement = document.getElementById('no-announcements-debug');
    const countdownDisplay = document.getElementById('countdown-display');
    const countdownNumber = document.getElementById('countdown-number');

    // è‡ªåŠ¨æ¶ˆå¤±é…ç½®
    const AUTO_HIDE_DELAY = 2; // ç§’åè‡ªåŠ¨æ¶ˆå¤±
    let countdownTimer = null;
    let currentCountdown = AUTO_HIDE_DELAY;
    let isPaused = false;
    let isManuallyHidden = false;

    if (!banner || !content) {
      console.error('Banner elements not found');
      return;
    }

    // ä»APIè·å–å…¬å‘Šæ•°æ®
    fetch('https://api-g.lacs.cc/app/software/id/1/announcements?published=true&limit=3')
      .then(response => {
        console.log('API response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('API response data:', data);

        // æ£€æŸ¥ä¸¤ç§å¯èƒ½çš„æ•°æ®ç»“æ„
        let announcements = [];
        if (data.success) {
          if (data.data && Array.isArray(data.data)) {
            // æ ‡å‡†ç»“æ„ï¼šdataç›´æ¥æ˜¯æ•°ç»„
            announcements = data.data;
          } else if (data.data && data.data.announcements && Array.isArray(data.data.announcements)) {
            // å®é™…ç»“æ„ï¼šdata.announcementsæ˜¯æ•°ç»„
            announcements = data.data.announcements;
          }
        }

        if (announcements.length > 0) {
          console.log(`Found ${announcements.length} announcements from API`);

          // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå…¬å‘Š
          displayAnnouncement(announcements[0]);

          // æ˜¾ç¤ºæ¨ªå¹…
          showBanner();
        } else {
          console.log('No announcements available from API');
          hideBanner();
          showDebugMessage('APIè¿”å›ç©ºæ•°æ®');
        }
      })
      .catch(error => {
        console.error('Failed to load announcements from API:', error);
        hideBanner();
        showDebugMessage('APIè°ƒç”¨å¤±è´¥');
      });

    // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶ç›‘å¬å™¨
    if (banner) {
      banner.addEventListener('mouseenter', pauseCountdown);
      banner.addEventListener('mouseleave', resumeCountdown);
    }

    function showBanner() {
      banner.style.display = 'block';
      setTimeout(() => {
        banner.classList.remove('-translate-y-full');
        banner.classList.add('translate-y-0');

        // æ˜¾ç¤ºæ¨ªå¹…åå¼€å§‹å€’è®¡æ—¶
        startCountdown();
      }, 100);
    }

    function hideBanner() {
      banner.style.display = 'none';
    }

    function showDebugMessage(message) {
      if (debugElement) {
        debugElement.textContent = message;
        debugElement.classList.remove('hidden');
        // 5ç§’åéšè—è°ƒè¯•ä¿¡æ¯
        setTimeout(() => {
          debugElement.classList.add('hidden');
        }, 5000);
      }
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
      if (isManuallyHidden) return;

      currentCountdown = AUTO_HIDE_DELAY;
      updateCountdownDisplay();

      // æ˜¾ç¤ºå€’è®¡æ—¶
      if (countdownDisplay) {
        countdownDisplay.style.display = 'flex';
      }

      countdownTimer = setInterval(() => {
        if (isPaused || isManuallyHidden) return;

        currentCountdown--;
        updateCountdownDisplay();

        if (currentCountdown <= 0) {
          clearInterval(countdownTimer);
          autoHideBanner();
        }
      }, 1000);
    }

    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    function updateCountdownDisplay() {
      if (countdownNumber) {
        countdownNumber.textContent = currentCountdown;

        // æ·»åŠ æ•°å­—å˜åŒ–åŠ¨ç”»
        countdownNumber.style.transform = 'scale(1.2)';
        setTimeout(() => {
          countdownNumber.style.transform = 'scale(1)';
        }, 150);

        // æœ€å3ç§’æ—¶æ·»åŠ è­¦å‘Šæ ·å¼
        if (currentCountdown <= 3) {
          countdownDisplay.classList.add('animate-pulse');
          countdownDisplay.style.backgroundColor = 'rgba(239, 68, 68, 0.4)';
          countdownDisplay.style.borderColor = 'rgba(239, 68, 68, 0.6)';
          countdownDisplay.style.border = '1px solid';
        } else {
          countdownDisplay.classList.remove('animate-pulse');
          countdownDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
          countdownDisplay.style.border = 'none';
        }

        // æœ€å1ç§’æ—¶æ·»åŠ å¼ºçƒˆè­¦å‘Š
        if (currentCountdown === 1) {
          countdownDisplay.style.backgroundColor = 'rgba(239, 68, 68, 0.6)';
          countdownDisplay.classList.add('animate-bounce');
        }
      }
    }

    // è‡ªåŠ¨éšè—æ¨ªå¹…
    function autoHideBanner() {
      if (isManuallyHidden) return;

      banner.classList.add('-translate-y-full');
      banner.classList.remove('translate-y-0');

      setTimeout(() => {
        banner.style.display = 'none';
        if (countdownDisplay) {
          countdownDisplay.style.display = 'none';
        }
      }, 500);
    }

    // æš‚åœå€’è®¡æ—¶
    function pauseCountdown() {
      isPaused = true;
      if (countdownDisplay) {
        countdownDisplay.style.opacity = '0.3';
      }
    }

    // æ¢å¤å€’è®¡æ—¶
    function resumeCountdown() {
      isPaused = false;
      if (countdownDisplay) {
        countdownDisplay.style.opacity = '0.6';
      }
    }

    // åœæ­¢å€’è®¡æ—¶
    function stopCountdown() {
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      if (countdownDisplay) {
        countdownDisplay.style.display = 'none';
      }
    }

    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.stopCountdown = stopCountdown;
    window.isManuallyHidden = isManuallyHidden;
    
    function displayAnnouncement(announcement) {
      const typeIcon = getTypeIcon(announcement.type || 'general');
      const typeLabel = getTypeLabel(announcement.type || 'general');
      const formattedDate = formatDate(announcement.publishedAt);
      const announcementContent = announcement.content || announcement.title || 'æš‚æ— å†…å®¹';

      // æ£€æŸ¥å†…å®¹æ˜¯å¦éœ€è¦æˆªæ–­
      const maxLength = 100;
      const needsTruncation = announcementContent.length > maxLength;
      const shortContent = needsTruncation ?
        announcementContent.substring(0, maxLength) + '...' : announcementContent;

      content.innerHTML = `
        <div class="flex items-start justify-between py-4">
          <div class="flex items-start space-x-4 flex-1 min-w-0">
            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-xl">
              ${typeIcon}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-white text-base leading-6 mb-2">
                ${escapeHtml(announcement.title || 'å…¬å‘Šæ ‡é¢˜')}
              </div>
              <div class="text-blue-50 text-sm leading-relaxed mb-3 opacity-90">
                <div id="announcement-short-content">
                  ${escapeHtml(shortContent)}
                </div>
                ${needsTruncation ? `
                  <div id="announcement-full-content" class="hidden">
                    ${escapeHtml(announcementContent)}
                  </div>
                  <button
                    id="toggle-content-btn"
                    class="text-blue-200 hover:text-white text-xs font-medium mt-1 underline transition-colors"
                    onclick="toggleAnnouncementContent()"
                  >
                    å±•å¼€å…¨æ–‡
                  </button>
                ` : ''}
              </div>
              <div class="flex items-center space-x-3 flex-wrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-white bg-opacity-25 text-white">
                  ${typeLabel}
                </span>
                <span class="text-xs text-blue-100 font-medium">
                  ğŸ“… ${formattedDate}
                </span>
                ${announcement.version ? `
                  <span class="text-xs text-blue-100 font-medium">
                    ğŸ·ï¸ v${escapeHtml(announcement.version)}
                  </span>
                ` : ''}
                ${announcement.metadata && announcement.metadata.urgent ? `
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-red-500 bg-opacity-80 text-white animate-pulse">
                    ğŸš¨ ç´§æ€¥
                  </span>
                ` : ''}
              </div>
            </div>
          </div>
          <button class="flex-shrink-0 ml-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200 group" onclick="closeBanner(this)" aria-label="å…³é—­å…¬å‘Š">
            <svg class="w-5 h-5 text-white group-hover:text-blue-100 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;
    }
    
    function getTypeIcon(type) {
      switch (type) {
        case 'update': return 'ğŸ”„';
        case 'feature': return 'âœ¨';
        case 'security': return 'ğŸ”’';
        case 'maintenance': return 'ğŸ”§';
        case 'bugfix': return 'ğŸ›';
        case 'general': return 'ğŸ“¢';
        case 'promotion': return 'ğŸ‰';
        case 'deprecation': return 'âš ï¸';
        default: return 'ğŸ“¢';
      }
    }
    
    function getTypeLabel(type) {
      switch (type) {
        case 'update': return 'æ›´æ–°';
        case 'feature': return 'æ–°åŠŸèƒ½';
        case 'security': return 'å®‰å…¨';
        case 'maintenance': return 'ç»´æŠ¤';
        case 'bugfix': return 'ä¿®å¤';
        case 'general': return 'é€šçŸ¥';
        case 'promotion': return 'æ¨å¹¿';
        case 'deprecation': return 'å¼ƒç”¨';
        default: return 'é€šçŸ¥';
      }
    }
    
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = now.getTime() - date.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'ä»Šå¤©';
        if (diffDays === 1) return 'æ˜¨å¤©';
        if (diffDays < 7) return `${diffDays}å¤©å‰`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`;
        
        return date.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return 'æœªçŸ¥æ—¶é—´';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  });

  // å…¨å±€å…³é—­æ¨ªå¹…å‡½æ•°
  window.closeBanner = function(button) {
    const banner = button.closest('.announcement-banner');
    if (banner) {
      // æ ‡è®°ä¸ºæ‰‹åŠ¨éšè—
      window.isManuallyHidden = true;

      // åœæ­¢å€’è®¡æ—¶
      if (window.stopCountdown) {
        window.stopCountdown();
      }

      banner.classList.add('-translate-y-full');
      banner.classList.remove('translate-y-0');

      // å»¶è¿Ÿéšè—ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        banner.style.display = 'none';
        const countdownDisplay = document.getElementById('countdown-display');
        if (countdownDisplay) {
          countdownDisplay.style.display = 'none';
        }
      }, 500);
    }
  };

  // å…¨å±€å±•å¼€/æ”¶èµ·å…¬å‘Šå†…å®¹å‡½æ•°
  window.toggleAnnouncementContent = function() {
    const shortContent = document.getElementById('announcement-short-content');
    const fullContent = document.getElementById('announcement-full-content');
    const toggleBtn = document.getElementById('toggle-content-btn');

    if (shortContent && fullContent && toggleBtn) {
      const isExpanded = !fullContent.classList.contains('hidden');

      if (isExpanded) {
        // æ”¶èµ·
        shortContent.classList.remove('hidden');
        fullContent.classList.add('hidden');
        toggleBtn.textContent = 'å±•å¼€å…¨æ–‡';
      } else {
        // å±•å¼€
        shortContent.classList.add('hidden');
        fullContent.classList.remove('hidden');
        toggleBtn.textContent = 'æ”¶èµ·';
      }
    }
  };
</script>
