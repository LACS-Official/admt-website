---
/**
 * åŠ¨æ€ç‰ˆæœ¬é…ç½®ç»„ä»¶
 * é€šè¿‡APIè·å–DeviceManager Proæœ€æ–°ç‰ˆæœ¬ä¿¡æ¯å¹¶æ›´æ–°ä¸‹è½½é…ç½®
 */
import { SITE_CONFIG } from '@/config/site';
import { deviceManagerVersionApi, type SoftwareVersionHistory, VersionApiService, versionApi } from '@/services/versionApi';

// å°è¯•è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
let latestVersion: SoftwareVersionHistory | null = null;
let versionStats = null;
let dynamicDownloadConfig = null;
let errorMessage = '';

try {
  console.log('Fetching DeviceManager Pro version data...');

  // è·å–æœ€æ–°ç‰ˆæœ¬
  latestVersion = await deviceManagerVersionApi.getLatestDeviceManagerVersion();

  if (latestVersion) {
    console.log('Successfully fetched DeviceManager Pro version:', latestVersion.version);

    // åªæœ‰åœ¨æœ‰ç‰ˆæœ¬æ•°æ®æ—¶æ‰è·å–ç»Ÿè®¡å’Œç”Ÿæˆé…ç½®
    versionStats = await deviceManagerVersionApi.getDeviceManagerStats();
    dynamicDownloadConfig = await deviceManagerVersionApi.generateDynamicDownloadConfig();
  } else {
    console.warn('No version data available for DeviceManager Pro (Software ID: 6)');
    errorMessage = 'APIæš‚æ— ç‰ˆæœ¬æ•°æ®ï¼Œè¯·ä½¿ç”¨é™æ€ä¸‹è½½é“¾æ¥';
  }
} catch (error: any) {
  console.error('Failed to fetch DeviceManager Pro version data:', error);
  errorMessage = `ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥: ${error?.message || 'æœªçŸ¥é”™è¯¯'}ï¼Œè¯·ä½¿ç”¨é™æ€ä¸‹è½½é“¾æ¥`;
}

// æ–°å¢ï¼šè·å–è½¯ä»¶ä¿¡æ¯ä»¥è·å–æœ€æ–°çš„ä¸‹è½½é“¾æ¥
let softwareInfo = null;
try {
  console.log('Fetching software info for latest download URL...');
  const response = await versionApi.getSoftwareInfo();
  if (response && response.success) {
    softwareInfo = response.data;
    console.log('Successfully fetched software info:', softwareInfo);
    
    // æ›´æ–°åŠ¨æ€ä¸‹è½½é…ç½®ä¸­çš„Windowsé“¾æ¥
    if (dynamicDownloadConfig && softwareInfo.latestDownloadUrl) {
      dynamicDownloadConfig.windows.installer.url = softwareInfo.latestDownloadUrl;
      console.log('Updated Windows download URL to:', softwareInfo.latestDownloadUrl);
    }
  } else {
    console.warn('Failed to fetch software info or invalid response');
    // å³ä½¿è½¯ä»¶ä¿¡æ¯è·å–å¤±è´¥ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨å·²æœ‰çš„dynamicDownloadConfig
  }
} catch (error: any) {
  console.error('Failed to fetch software info:', error);
  // å³ä½¿è½¯ä»¶ä¿¡æ¯è·å–å¤±è´¥ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨å·²æœ‰çš„dynamicDownloadConfig
}

// å¦‚æœæ²¡æœ‰ä»è®¾å¤‡ç®¡ç†å™¨APIè·å–åˆ°é…ç½®ï¼Œåˆ™å°è¯•ä»è½¯ä»¶ä¿¡æ¯APIè·å–åŸºç¡€é…ç½®
if (!dynamicDownloadConfig && softwareInfo) {
  dynamicDownloadConfig = {
    version: softwareInfo.currentVersion,
    windows: {
      installer: {
        name: "å®‰è£…ç¨‹åº",
        filename: `ç©æœºç®¡å®¶-${softwareInfo.currentVersion}-Setup.exe`,
        size: "æœªçŸ¥",
        url: softwareInfo.latestDownloadUrl || "#",
        description: "æ¨èï¼šå®Œæ•´å®‰è£…åŒ…ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½"
      }
    }
  };
  console.log('Generated fallback download config from software info');
}

// ä½¿ç”¨ä»APIè·å–çš„åŠ¨æ€ä¸‹è½½é…ç½®
const dynamicDownloads = dynamicDownloadConfig;
---

<!-- ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºç»„ä»¶ -->
<div class="version-info-container" data-version-info>
  {latestVersion ? (
    <div class="version-success">
      <div class="version-badge">
        <span class="version-label">æœ€æ–°ç‰ˆæœ¬</span>
        <span class="version-number">{latestVersion.version}</span>
      </div>
      <div class="version-details">
        <span class="release-date">
          å‘å¸ƒæ—¥æœŸï¼š{VersionApiService.formatReleaseDate(latestVersion.releaseDate)}
        </span>
        {latestVersion.fileSize && (
          <span class="file-size">
            æ–‡ä»¶å¤§å°ï¼š{latestVersion.fileSize}
          </span>
        )}
        {latestVersion.isStable && (
          <span class="stable-badge">ç¨³å®šç‰ˆ</span>
        )}
      </div>
      {latestVersion.releaseNotes && (
        <div class="release-notes">
          <h4>æ›´æ–°è¯´æ˜ï¼š</h4>
          <p>{latestVersion.releaseNotes}</p>
        </div>
      )}
      
      <!-- Windowså¹³å°é€‰æ‹© -->
      <div class="platform-selector">
        <h3 class="platform-title">ä¸‹è½½</h3>
        <div class="platform-options">
          <!-- Windows -->
          <div class="platform-option" data-platform="windows">
            <div class="platform-icon">ğŸªŸ</div>
            <div class="platform-info">
              <h4>Windows</h4>
              <p>Windows 10 (64ä½) æˆ–æ›´é«˜ç‰ˆæœ¬</p>
              <a
                href={dynamicDownloads?.windows?.installer?.url || SITE_CONFIG.downloads.windows.installer.url}
                class="download-button"
                data-download-type="installer"
                data-platform="windows"
              >
                <span class="download-name">å®‰è£…ç¨‹åº</span>
                <span class="download-info">
                  <span class="download-filename">ç©æœºç®¡å®¶-{dynamicDownloads?.version || softwareInfo?.currentVersion || SITE_CONFIG.product.version}-Setup.exe</span>
                  <span class="download-size">(æœªçŸ¥)</span>
                </span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  ) : softwareInfo ? (
    <div class="version-success">
      <div class="version-badge">
        <span class="version-label">å½“å‰ç‰ˆæœ¬</span>
        <span class="version-number">{softwareInfo.currentVersion}</span>
      </div>
      <div class="version-details">
        <span class="release-date">
          æ›´æ–°æ—¶é—´ï¼š{new Date(softwareInfo.updatedAt).toLocaleDateString('zh-CN')}
        </span>
      </div>
      
      <!-- Windowså¹³å°é€‰æ‹© -->
      <div class="platform-selector">
        <h3 class="platform-title">ä¸‹è½½</h3>
        <div class="platform-options">
          <!-- Windows -->
          <div class="platform-option" data-platform="windows">
            <div class="platform-icon">ğŸªŸ</div>
            <div class="platform-info">
              <h4>Windows</h4>
              <p>Windows 10 (64ä½) æˆ–æ›´é«˜ç‰ˆæœ¬</p>
              <a
                href={dynamicDownloads?.windows?.installer?.url || softwareInfo.latestDownloadUrl || SITE_CONFIG.downloads.windows.installer.url}
                class="download-button"
                data-download-type="installer"
                data-platform="windows"
              >
                <span class="download-name">å®‰è£…ç¨‹åº</span>
                <span class="download-info">
                  <span class="download-filename">ç©æœºç®¡å®¶-{softwareInfo.currentVersion}-Setup.exe</span>
                  <span class="download-size">(æœªçŸ¥)</span>
                </span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  ) : (
    <div class="version-error">
      <span class="error-icon">âš ï¸</span>
      <span class="error-message">{errorMessage}</span>
    </div>
  )}
</div>

<!-- åŠ¨æ€ä¸‹è½½é…ç½®æ•°æ® -->
<script type="application/json" id="dynamic-downloads-data" is:inline set:html={JSON.stringify(dynamicDownloads || null)}></script>

<!-- ç‰ˆæœ¬ä¿¡æ¯æ•°æ® -->
<script type="application/json" id="version-info-data" is:inline set:html={JSON.stringify({
  latestVersion: latestVersion || null,
  versionStats: versionStats || null,
  errorMessage: errorMessage || '',
  softwareInfo: softwareInfo || null
})}></script>

<style>
  .version-info-container {
    margin: 1rem 0;
    padding: 1.5rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #e2e8f0;
  }

  .version-success {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .version-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .version-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
  }

  .version-number {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    background: #ffffff;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .version-details {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    font-size: 0.875rem;
    color: #64748b;
  }

  .stable-badge {
    background: #dcfce7;
    color: #166534;
    padding: 0.125rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
    font-size: 0.75rem;
  }

  .release-notes {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: #ffffff;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .release-notes h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .release-notes p {
    margin: 0;
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.5;
  }

  .version-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #dc2626;
    font-size: 0.875rem;
  }

  /* å¹³å°é€‰æ‹©å™¨æ ·å¼ */
  .platform-selector {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
  }

  .platform-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    text-align: center;
  }

  .platform-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .platform-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
  }

  .platform-option:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }

  .platform-icon {
    font-size: 1.5rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: #f1f5f9;
  }

  .platform-info {
    flex: 1;
  }

  .platform-info h4 {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 0.25rem 0;
  }

  .platform-info p {
    font-size: 0.75rem;
    color: #64748b;
    margin: 0 0 0.5rem 0;
  }

  .download-button {
    display: block;
    width: 100%;
    padding: 0.5rem;
    background: #1e293b;
    color: white;
    text-align: center;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: background 0.2s ease;
  }

  .download-button:hover:not(:disabled) {
    background: #0f172a;
  }

  .download-info {
    display: block;
    font-size: 0.75rem;
    opacity: 0.9;
    margin-top: 0.25rem;
  }

  /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
  :global(.dark) .version-info-container {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: #475569;
  }

  :global(.dark) .version-number {
    background: #334155;
    color: #f1f5f9;
    border-color: #475569;
  }

  :global(.dark) .release-notes {
    background: #334155;
    border-color: #475569;
  }

  :global(.dark) .release-notes h4 {
    color: #e2e8f0;
  }

  :global(.dark) .release-notes p {
    color: #cbd5e1;
  }

  :global(.dark) .platform-option {
    background: #334155;
    border-color: #475569;
  }

  :global(.dark) .platform-icon {
    background: #475569;
  }

  :global(.dark) .platform-info h4 {
    color: #f1f5f9;
  }

  :global(.dark) .platform-info p {
    color: #94a3b8;
  }
</style>