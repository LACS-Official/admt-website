---
/**
 * 动态版本配置组件
 * 通过API获取最新版本信息并更新下载配置
 * 只有最新版本提供下载链接，其他版本只显示日志
 */
import { SITE_CONFIG } from '@/config/site';
import { deviceManagerVersionApi, type SoftwareVersionHistory } from '@/services/versionApi';
import DownloadsSection from '@/components/DownloadsSection.astro';

// 尝试获取最新版本信息和所有版本信息
let latestVersion: SoftwareVersionHistory | null = null;
let allVersions: SoftwareVersionHistory[] = [];
let dynamicDownloadConfig = null;
let errorMessage = '';

try {
  console.log('Fetching version data with download policy...');

  // 获取版本信息（包含下载策略）
  const versionData = await deviceManagerVersionApi.getAllVersionsWithDownloadPolicy();
  
  if (versionData.latestVersion) {
    latestVersion = versionData.latestVersion;
    allVersions = versionData.allVersions;
    
    console.log('Successfully fetched version data:');
    console.log('- Latest version:', latestVersion.version, 'with ID:', latestVersion.id);
    console.log('- Total versions:', allVersions.length);
    console.log('- Latest version download URL:', latestVersion.downloadLinks?.official);

    // 生成动态下载配置
    dynamicDownloadConfig = await deviceManagerVersionApi.generateDynamicDownloadConfig();
  } else {
    console.warn('No version data available');
    errorMessage = 'API暂无版本数据，请稍后重试';
  }
} catch (error: any) {
  console.error('Failed to fetch version data:', error);
  errorMessage = `版本信息获取失败: ${error?.message || '未知错误'}，请稍后重试`;
}

// 使用从API获取的动态下载配置
const dynamicDownloads = dynamicDownloadConfig;
---

<!-- 版本信息显示组件 -->
<div class="version-info-container" data-version-info>
  {latestVersion ? (
    <div class="version-success">
      <div class="version-badge">
        <span class="version-label">最新版本</span>
        <span class="version-number">{latestVersion.version}</span>
        <span class="version-id">ID: {latestVersion.id}</span>
      </div>
      <div class="version-details">
        <span class="release-date">
          发布日期：{new Date(latestVersion.releaseDate).toLocaleDateString('zh-CN')}
        </span>
        {latestVersion.fileSize && (
          <span class="file-size">
            文件大小：{latestVersion.fileSize}
          </span>
        )}
        {latestVersion.isStable && (
          <span class="stable-badge">稳定版</span>
        )}
      </div>
            <!-- Windows平台下载 -->
      <div class="platform-selector">
        {latestVersion.downloadLinks?.official ? (
          <DownloadsSection latestVersion={latestVersion} />
        ) : (
          <div class="download-unavailable">
            <span>暂无下载链接</span>
          </div>
        )}
        
      </div>
      {latestVersion.releaseNotes && (
        <div class="release-notes">
          <h4>更新说明：</h4>
          <p>{latestVersion.releaseNotes}</p>
        </div>
      )}
      

    </div>
  ) : (
    <div class="version-error">
      <span class="error-icon">⚠️</span>
      <span class="error-message">{errorMessage}</span>
    </div>
  )}
</div>

<!-- 动态下载配置数据 -->
<script type="application/json" id="dynamic-downloads-data" is:inline set:html={JSON.stringify(dynamicDownloads || null)}></script>

<!-- 版本信息数据 -->
<script type="application/json" id="version-info-data" is:inline set:html={JSON.stringify({
  latestVersion: latestVersion || null,
  allVersions: allVersions || [],
  dynamicDownloadConfig: dynamicDownloadConfig || null,
  errorMessage: errorMessage || ''
})}></script>

<style>
  .version-info-container {
    margin: 1rem 0;
    padding: 1.5rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #e2e8f0;
  }

  .version-success {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .version-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .version-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
  }

  .version-number {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    background: #ffffff;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .version-details {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    font-size: 0.875rem;
    color: #64748b;
  }

  .version-id {
    font-size: 0.75rem;
    color: #64748b;
    background: #f1f5f9;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-weight: 500;
  }

  .download-notice {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #92400e;
  }

  .download-unavailable {
    display: block;
    width: 100%;
    padding: 0.5rem;
    background: #f3f4f6;
    color: #6b7280;
    text-align: center;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid #d1d5db;
  }

  .stable-badge {
    background: #dcfce7;
    color: #166534;
    padding: 0.125rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
    font-size: 0.75rem;
  }

  .release-notes {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: #ffffff;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .release-notes h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .release-notes p {
    margin: 0;
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.5;
  }

  .version-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #dc2626;
    font-size: 0.875rem;
  }

  /* 平台选择器样式 */
  .platform-selector {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
  }

  .platform-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    text-align: center;
  }

  .platform-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .platform-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
  }

  .platform-option:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }

  .platform-icon {
    font-size: 1.5rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: #f1f5f9;
  }

  .platform-info {
    flex: 1;
  }

  .platform-info h4 {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 0.25rem 0;
  }

  .platform-info p {
    font-size: 0.75rem;
    color: #64748b;
    margin: 0 0 0.5rem 0;
  }

  .download-button {
    display: block;
    width: 100%;
    padding: 0.5rem;
    color: white;
    text-align: center;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .download-buttons-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .download-button.primary {
    background: #1e293b;
    color: white;
  }
  
  .download-button.secondary {
    background: #64748b;
    color: white;
  }
  
  .download-button:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .download-info {
    display: block;
    font-size: 0.75rem;
    opacity: 0.9;
    margin-top: 0.25rem;
  }

  /* 深色模式支持 */
  :global(.dark) .version-info-container {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: #475569;
  }

  :global(.dark) .version-number {
    background: #334155;
    color: #f1f5f9;
    border-color: #475569;
  }

  :global(.dark) .version-id {
    background: #475569;
    color: #cbd5e1;
  }

  :global(.dark) .download-notice {
    background: #451a03;
    border-color: #92400e;
    color: #fbbf24;
  }

  :global(.dark) .download-unavailable {
    background: #374151;
    color: #9ca3af;
    border-color: #4b5563;
  }

  :global(.dark) .release-notes {
    background: #334155;
    border-color: #475569;
  }

  :global(.dark) .release-notes h4 {
    color: #e2e8f0;
  }

  :global(.dark) .release-notes p {
    color: #cbd5e1;
  }

  :global(.dark) .platform-option {
    background: #334155;
    border-color: #475569;
  }

  :global(.dark) .platform-icon {
    background: #475569;
  }

  :global(.dark) .platform-info h4 {
    color: #f1f5f9;
  }

  :global(.dark) .platform-info p {
    color: #94a3b8;
  }
</style>