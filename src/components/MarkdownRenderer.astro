---
export interface Props {
  content: string;
  className?: string;
}

const { content, className = '' } = Astro.props;

// ç®€å•çš„markdownåˆ°HTMLè½¬æ¢å‡½æ•°
function markdownToHtml(markdown: string): string {
  let html = markdown;
  
  // ä»£ç å—ï¼ˆå¿…é¡»åœ¨å…¶ä»–è§„åˆ™ä¹‹å‰å¤„ç†ï¼‰
  html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
    const language = lang || '';
    return `<pre class="code-block" data-language="${language}"><code>${escapeHtml(code.trim())}</code></pre>`;
  });
  
  // è¡Œå†…ä»£ç 
  html = html.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
  
  // æ ‡é¢˜
  html = html.replace(/^### (.*$)/gim, '<h3 class="heading-3">$1</h3>');
  html = html.replace(/^## (.*$)/gim, '<h2 class="heading-2">$1</h2>');
  html = html.replace(/^# (.*$)/gim, '<h1 class="heading-1">$1</h1>');
  
  // ç²—ä½“å’Œæ–œä½“
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>');
  html = html.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');
  
  // é“¾æ¥
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="link">$1</a>');
  
  // æœ‰åºåˆ—è¡¨
  html = html.replace(/^\d+\. (.*$)/gim, '<li class="list-item-ordered">$1</li>');
  
  // æ— åºåˆ—è¡¨
  html = html.replace(/^[*-] (.*$)/gim, '<li class="list-item-unordered">$1</li>');
  
  // åŒ…è£…åˆ—è¡¨é¡¹
  html = html.replace(/(<li class="list-item-ordered">.*?<\/li>)/gs, (match) => {
    return `<ol class="ordered-list">${match}</ol>`;
  });
  html = html.replace(/(<li class="list-item-unordered">.*?<\/li>)/gs, (match) => {
    return `<ul class="unordered-list">${match}</ul>`;
  });
  
  // å¼•ç”¨
  html = html.replace(/^> (.*$)/gim, '<blockquote class="blockquote">$1</blockquote>');
  
  // æ°´å¹³çº¿
  html = html.replace(/^---$/gim, '<hr class="horizontal-rule">');
  
  // æ®µè½ï¼ˆæœ€åå¤„ç†ï¼‰
  html = html.split('\n\n').map(paragraph => {
    paragraph = paragraph.trim();
    if (!paragraph) return '';
    
    // è·³è¿‡å·²ç»æ˜¯HTMLæ ‡ç­¾çš„å†…å®¹
    if (paragraph.startsWith('<') && paragraph.endsWith('>')) {
      return paragraph;
    }
    
    // è·³è¿‡åˆ—è¡¨é¡¹
    if (paragraph.includes('<li class=') || paragraph.includes('<ol class=') || paragraph.includes('<ul class=')) {
      return paragraph;
    }
    
    // è·³è¿‡æ ‡é¢˜
    if (paragraph.includes('<h1 class=') || paragraph.includes('<h2 class=') || paragraph.includes('<h3 class=')) {
      return paragraph;
    }
    
    // è·³è¿‡ä»£ç å—
    if (paragraph.includes('<pre class=')) {
      return paragraph;
    }
    
    // è·³è¿‡å¼•ç”¨
    if (paragraph.includes('<blockquote class=')) {
      return paragraph;
    }
    
    // è·³è¿‡æ°´å¹³çº¿
    if (paragraph.includes('<hr class=')) {
      return paragraph;
    }
    
    return `<p class="paragraph">${paragraph}</p>`;
  }).join('\n');
  
  return html;
}

function escapeHtml(text: string): string {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

const htmlContent = markdownToHtml(content);
---

<div class={`markdown-content ${className}`}>
  <Fragment set:html={htmlContent} />
</div>

<style>
  .markdown-content {
    @apply text-gray-900 dark:text-gray-100;
  }
  
  .markdown-content :global(.heading-1) {
    @apply text-3xl font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-4 mb-6 mt-8;
  }
  
  .markdown-content :global(.heading-2) {
    @apply text-2xl font-semibold text-gray-900 dark:text-white mt-8 mb-4;
  }
  
  .markdown-content :global(.heading-3) {
    @apply text-xl font-semibold text-gray-900 dark:text-white mt-6 mb-3;
  }
  
  .markdown-content :global(.paragraph) {
    @apply text-gray-700 dark:text-gray-300 leading-relaxed mb-4;
  }
  
  .markdown-content :global(.link) {
    @apply text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 no-underline hover:underline;
  }
  
  .markdown-content :global(.ordered-list) {
    @apply text-gray-700 dark:text-gray-300 mb-4 pl-6;
  }
  
  .markdown-content :global(.unordered-list) {
    @apply text-gray-700 dark:text-gray-300 mb-4 pl-6;
  }
  
  .markdown-content :global(.list-item-ordered) {
    @apply mb-2 list-decimal;
  }
  
  .markdown-content :global(.list-item-unordered) {
    @apply mb-2 list-disc;
  }
  
  .markdown-content :global(.inline-code) {
    @apply bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 px-2 py-1 rounded text-sm font-mono;
  }
  
  .markdown-content :global(.code-block) {
    @apply bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 p-4 rounded-lg overflow-x-auto mb-4 border border-gray-200 dark:border-gray-700;
  }
  
  .markdown-content :global(.code-block code) {
    @apply font-mono text-sm;
  }
  
  .markdown-content :global(.blockquote) {
    @apply border-l-4 border-blue-500 pl-4 italic text-gray-600 dark:text-gray-400 mb-4 bg-blue-50 dark:bg-blue-900/20 py-2;
  }
  
  .markdown-content :global(.horizontal-rule) {
    @apply border-gray-300 dark:border-gray-600 my-8;
  }
  
  .markdown-content :global(strong) {
    @apply font-semibold text-gray-900 dark:text-white;
  }
  
  .markdown-content :global(em) {
    @apply italic;
  }
  
  /* è¡¨æ ¼æ ·å¼ */
  .markdown-content :global(table) {
    @apply w-full border-collapse border border-gray-300 dark:border-gray-600 mb-4;
  }
  
  .markdown-content :global(th), 
  .markdown-content :global(td) {
    @apply border border-gray-300 dark:border-gray-600 px-4 py-2 text-left;
  }
  
  .markdown-content :global(th) {
    @apply bg-gray-50 dark:bg-gray-700 font-semibold;
  }
  
  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .markdown-content :global(.heading-1) {
      @apply text-2xl;
    }
    
    .markdown-content :global(.heading-2) {
      @apply text-xl;
    }
    
    .markdown-content :global(.heading-3) {
      @apply text-lg;
    }
    
    .markdown-content :global(.code-block) {
      @apply text-xs;
    }
  }
</style>

<script>
  // æ·»åŠ ä»£ç å¤åˆ¶åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('.code-block');
    
    codeBlocks.forEach((block) => {
      // åˆ›å»ºå¤åˆ¶æŒ‰é’®
      const copyButton = document.createElement('button');
      copyButton.innerHTML = 'ğŸ“‹';
      copyButton.className = 'absolute top-2 right-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-2 py-1 rounded text-sm transition-colors duration-200';
      copyButton.title = 'å¤åˆ¶ä»£ç ';
      
      // è®¾ç½®ç›¸å¯¹å®šä½
      block.style.position = 'relative';
      block.appendChild(copyButton);
      
      // å¤åˆ¶åŠŸèƒ½
      copyButton.addEventListener('click', async () => {
        const code = block.querySelector('code');
        if (code) {
          try {
            await navigator.clipboard.writeText(code.textContent || '');
            copyButton.innerHTML = 'âœ…';
            copyButton.title = 'å·²å¤åˆ¶';
            
            setTimeout(() => {
              copyButton.innerHTML = 'ğŸ“‹';
              copyButton.title = 'å¤åˆ¶ä»£ç ';
            }, 2000);
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            copyButton.innerHTML = 'âŒ';
            setTimeout(() => {
              copyButton.innerHTML = 'ğŸ“‹';
            }, 2000);
          }
        }
      });
    });
  });
</script>
